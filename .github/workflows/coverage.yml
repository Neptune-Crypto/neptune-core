name: Coverage

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Check disk and attempt to free space if low
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Disk usage (root) ==="
          df -h /
          echo "=== Inode usage (root) ==="
          df -i /

          avail_kb() { df --output=avail / | tail -n1 | tr -d '[:space:]'; }
          avail=$(avail_kb)
          echo "Available KB: $avail"

          # Thresholds (adjust as needed)
          min_kb=500000    # abort if below this after cleanup (~500 MB)
          danger_kb=200000 # consider this "dangerously low" (~200 MB)

          if [ "$avail" -lt "$min_kb" ]; then
            echo "Low disk (< ${min_kb} KB). Attempting to free common caches..."
            # Remove common large caches that are safe on hosted runners
            sudo rm -rf /home/runner/.cache/pip || true
            rm -rf ~/.cache/pip || true
            rm -rf ~/.npm || true
            rm -rf ~/.cache/yarn || true
            sudo rm -rf /home/runner/actions-runner/cached/* /home/runner/actions-runner/_diag/* || true
            sudo apt-get clean || true

            # Recompute available space
            avail=$(avail_kb)
            echo "Available KB after initial cleanup: $avail"

            # If still dangerously low, remove cargo registry to free significant space
            if [ "$avail" -lt "$danger_kb" ]; then
              echo "Disk critically low (< ${danger_kb} KB). Removing ~/.cargo/registry to free space..."
              rm -rf ~/.cargo/registry || true
              # optionally remove git checkout cache too (uncomment if desired)
              # rm -rf ~/.cargo/git || true

              # Recompute available space after heavy cleanup
              avail=$(avail_kb)
              echo "Available KB after removing cargo registry: $avail"
            fi

            # Final check: abort if still below min threshold
            if [ "$avail" -lt "$min_kb" ]; then
              echo "ERROR: Still low on disk space (< ${min_kb} KB) after cleanup. Aborting early to avoid runner failures."
              df -h /
              exit 1
            fi
          fi

      - name: Cache Cargo registry & target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Collect coverage data (skip doctests & benchmarks)
        shell: bash
        env:
          CI: true
        run: |
          set -euo pipefail
          # Run the coverage collection with a wall-clock timeout (adjust 30m if needed)
          timeout --preserve-status 30m bash -c \
            'cargo +nightly llvm-cov nextest \
              --lib --bins --tests --examples \
              --lcov --output-path lcov.info \
              -- \
              --skip mine_20_blocks_in_40_seconds \
              --skip hash_rate_independent_of_tx_size \
              --skip blocks_with_0_to_10_inputs_and_successors_are_valid \
              --skip can_cancel_preprocess_within_one_second \
              --skip can_cancel_merkle_tree_construction_within_two_seconds \
              --skip alice_updates_mutator_set_data_on_own_transaction \
              --skip can_sync_from \
              --skip can_sync_with_moving' 2>&1 | tee coverage_output.log || true

          cargo_exit=${PIPESTATUS[0]:-1}

          echo "=== Last lines of coverage output ==="
          tail -n 200 coverage_output.log || true

          echo "=== Listing files in workspace root (for debugging) ==="
          ls -lah || true

          echo "=== Disk usage after coverage run ==="
          df -h /

          if [ -f lcov.info ]; then
            echo "lcov.info generated: $(stat -c '%s %n' lcov.info || true)"
          else
            echo "lcov.info not found. Printing potential coverage artifacts:"
            ls -lah . || true
            grep -i "error\|failed\|panic" coverage_output.log || true
          fi

          # exit with the cargo command's exit code so Actions reflects test result
          exit $cargo_exit

      - name: Upload coverage to coveralls.io
        uses: coverallsapp/github-action@v2
        # If Coveralls requires a token, ensure it's configured in repo secrets.
        # env:
        #   COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}

      - name: Archive coverage results
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            lcov.info
            coverage_output.log